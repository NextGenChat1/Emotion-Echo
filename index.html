<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Emotion Echo - Back & Random Questions</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f0f4f8;
    margin: 0; padding: 20px;
    display: flex; flex-direction: column; align-items: center;
  }
  h1 { color: #0984e3; }
  #questionArea, #result, #shareDownload, #story, #quote, #chartArea {
    background: white; border-radius: 10px; padding: 20px; margin: 15px 0;
    max-width: 400px; width: 100%;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  button {
    margin: 5px;
    padding: 10px 18px;
    font-size: 16px;
    border: none;
    border-radius: 8px;
    background: #0984e3;
    color: white;
    cursor: pointer;
    transition: background 0.3s;
  }
  button:hover {
    background: #74b9ff;
  }
  .emoji {
    font-size: 48px;
    animation: popin 0.5s ease forwards;
    position: fixed;
    top: 40%;
    left: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none;
    user-select: none;
    z-index: 9999;
  }
  @keyframes popin {
    0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
    50% { opacity: 1; transform: translate(-50%, -50%) scale(1.3); }
    100% { opacity: 0; transform: translate(-50%, -50%) scale(1); }
  }
  #shareDownload button {
    background: #00b894;
  }
  #chartArea canvas {
    max-width: 100%;
  }
  #navButtons {
    display: flex;
    justify-content: center;
  }
  #navButtons button {
    width: 100px;
  }
</style>
</head>
<body>

<h1>Emotion Echo üîÆ</h1>

<div id="questionArea">
  <div id="questionText">How are you feeling right now?</div>
  <div>
    <button data-answer="Happy">üòä Happy</button>
    <button data-answer="Sad">üò¢ Sad</button>
    <button data-answer="Calm">üòå Calm</button>
  </div>
  <div id="navButtons">
    <button id="backBtn" disabled>‚¨ÖÔ∏è Back</button>
  </div>
</div>

<div id="result" style="display:none; white-space: pre-line;"></div>

<div id="story" style="display:none; font-style: italic; color: #2d3436;"></div>

<div id="quote" style="display:none; font-weight: 600; color: #0984e3; margin-top: 10px;"></div>

<div id="shareDownload" style="display:none; margin-top: 15px;">
  <button id="shareBtn">Share Your Echo</button>
</div>

<div id="chartArea" style="display:none; margin-top: 25px;">
  <canvas id="emotionChart" width="400" height="300"></canvas>
</div>

<audio id="bgMusic" loop></audio>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // All possible questions
  const allQuestions = [
    "How are you feeling right now?",
    "What‚Äôs your biggest emotion today?",
    "Describe your mood in one word.",
    "What made you smile recently?",
    "What emotion is strongest in you today?",
    "How would you rate your energy right now?",
    "What color matches your current feeling?",
    "If your mood was weather, what would it be?",
    "Which word best describes your heart now?",
    "What‚Äôs the vibe you want to carry today?"
  ];

  const dailyQuotes = [
    "Every day is a new beginning. Take a deep breath and start again.",
    "Your emotions are your superpower ‚Äî embrace them.",
    "Happiness often sneaks in through a door you didn‚Äôt know you left open.",
    "Calmness is the cradle of power.",
    "Sadness is but a wall between two gardens."
  ];

  const stories = [
    "Every emotion you feel is a brushstroke painting your unique life story.",
    "In the darkest times, your heart's echo shines the brightest.",
    "Your feelings are the compass guiding you to your true self.",
    "Even small steps in self-reflection lead to great journeys.",
    "Behind every tear is a story waiting to bloom into strength."
  ];

  const emojiMap = {
    Happy: "üòä",
    Sad: "üò¢",
    Calm: "üòå"
  };

  const musicMap = {
    Happy: "https://cdn.pixabay.com/download/audio/2022/03/28/audio_7a3e2fba46.mp3?filename=summer-happiness-5987.mp3",
    Sad: "https://cdn.pixabay.com/download/audio/2021/10/11/audio_40a3e27a3e.mp3?filename=soft-piano-ambient-10866.mp3",
    Calm: "https://cdn.pixabay.com/download/audio/2022/04/12/audio_4c7b3f162a.mp3?filename=calm-instrumental-10975.mp3"
  };

  const questionText = document.getElementById("questionText");
  const questionArea = document.getElementById("questionArea");
  const resultEl = document.getElementById("result");
  const storyEl = document.getElementById("story");
  const quoteEl = document.getElementById("quote");
  const shareDownload = document.getElementById("shareDownload");
  const shareBtn = document.getElementById("shareBtn");
  const bgMusic = document.getElementById("bgMusic");
  const chartArea = document.getElementById("chartArea");
  const backBtn = document.getElementById("backBtn");

  let answers = [];
  let questionIndices = [];
  let currentQIndex = 0;

  // Utility: get a random index from allQuestions excluding given indices
  function getRandomQuestionIndex(excludeIndices) {
    const available = allQuestions
      .map((q,i) => i)
      .filter(i => !excludeIndices.includes(i));
    if(available.length === 0) return null;
    return available[Math.floor(Math.random() * available.length)];
  }

  // Initialize questions array with unique random questions equal to desired length (e.g. 5)
  function initQuestions(num = 5) {
    questionIndices = [];
    while(questionIndices.length < num) {
      let idx = getRandomQuestionIndex(questionIndices);
      if(idx === null) break;
      questionIndices.push(idx);
    }
  }

  // Load saved answers and questionIndices from localStorage or start fresh
  function loadSaved() {
    const savedAnswers = localStorage.getItem('emotionEchoAnswers');
    const savedQIndices = localStorage.getItem('emotionEchoQIndices');
    const savedCurrent = localStorage.getItem('emotionEchoCurrent');

    if(savedAnswers && savedQIndices && savedCurrent !== null) {
      answers = JSON.parse(savedAnswers);
      questionIndices = JSON.parse(savedQIndices);
      currentQIndex = parseInt(savedCurrent,10);
      if(answers.length === questionIndices.length && answers.length > 0) {
        showResult();
        return true;
      }
      updateQuestion();
      updateNavButtons();
      return true;
    }
    return false;
  }

  // Save to localStorage
  function saveAll() {
    localStorage.setItem('emotionEchoAnswers', JSON.stringify(answers));
    localStorage.setItem('emotionEchoQIndices', JSON.stringify(questionIndices));
    localStorage.setItem('emotionEchoCurrent', currentQIndex.toString());
  }

  // Show current question text
  function updateQuestion() {
    questionText.innerText = allQuestions[questionIndices[currentQIndex]] || "How are you feeling?";
    // Highlight selected answer if exists
    document.querySelectorAll('#questionArea button').forEach(btn => {
      btn.style.backgroundColor = "#0984e3";
      btn.style.color = "white";
      if(answers[currentQIndex] === btn.dataset.answer) {
        btn.style.backgroundColor = "#00b894";
        btn.style.color = "white";
      }
    });
  }

  // Show/hide back button properly
  function updateNavButtons() {
    backBtn.disabled = currentQIndex === 0;
  }

  // Show animated emoji reaction
  function showEmoji(emoji) {
    const e = document.createElement("div");
    e.className = "emoji";
    e.innerText = emoji;
    document.body.appendChild(e);
    setTimeout(() => e.remove(), 1200);
  }

  // Play background music by mood
  function playMusic(mood) {
    if(musicMap[mood]) {
      bgMusic.src = musicMap[mood];
      bgMusic.volume = 0.15;
      bgMusic.play();
    }
  }

  // Show daily quote randomly
  function showQuote() {
    const q = dailyQuotes[Math.floor(Math.random() * dailyQuotes.length)];
    quoteEl.innerText = q;
    quoteEl.style.display = "block";
  }

  // Show final result with story & chart
  function showResult() {
    questionArea.style.display = "none";
    resultEl.style.display = "block";
    shareDownload.style.display = "block";
    chartArea.style.display = "block";

    let resultText = "Your Emotion Echo:\n\n";
    for(let i = 0; i < questionIndices.length; i++) {
      const qText = allQuestions[questionIndices[i]] || "";
      const ans = answers[i] || "No answer";
      resultText += `${qText}\n‚Üí ${ans}\n\n`;
    }
    resultEl.innerText = resultText;

    const randomStory = stories[Math.floor(Math.random() * stories.length)];
    storyEl.innerText = randomStory;
    storyEl.style.display = "block";

    drawChart();
  }

  // Draw simple pie chart of emotions count
  function drawChart() {
    const ctx = document.getElementById('emotionChart').getContext('2d');
    const counts = { Happy:0, Sad:0, Calm:0 };
    answers.forEach(a => { if(counts[a] !== undefined) counts[a]++; });
    const data = {
      labels: ['Happy', 'Sad', 'Calm'],
      datasets: [{
        data: [counts.Happy, counts.Sad, counts.Calm],
        backgroundColor: ['#00b894', '#d63031', '#
